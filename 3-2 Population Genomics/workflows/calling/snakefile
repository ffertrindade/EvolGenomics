## Workflow to estimate genotype likelihoods and perform SNP calling
## Used in the 3rd module Evolutionary Genomics of the curse Bioinformática y Genómica para la Biodiversidad
## Fernanda T. 03-07-2022

configfile: "config_calling.yaml"

rule all:
	input:
		expand("gl/{dataset}.beagle.gz", dataset=config["dataset"]),
		expand("gatk/{dataset}.{region}.filtered.vcf", dataset=config["dataset"], region=config["regions"])

rule genotype_likelihoods:
	message: """##### Running ANGSD... #####"""
	input:
		bam=expand("/home/courses/instructor01/leopard_data/{sample}.mapped.sorted.bam", sample=config["samples"]),
		bamlist={config["bamlist"]}
	output:
		"gl/{dataset}.beagle.gz",
		"gl/{dataset}.mafs.gz"
	threads:
		config["threads"]
	params:
		prefix={config["dataset"]},
		minInd={config["minInd"]}
	log:
		"logs/gl/{dataset}.log"
	shell:
		"angsd -bam {input.bamlist} -GL 2 -doMajorMinor 1 -doMaf 1 -doGlf 2 "
		"-minMapQ 24 -minQ 24 -SNP_pval 2e-6 -minMaf 0.05 "
		"-minInd {params.minInd} -out {params.prefix} -P {threads} 2> {log}"

rule snp_calling:
	message: """##### Running GATK... #####"""
	input:
		bam=expand("/home/courses/instructor01/leopard_data/{sample}.mapped.sorted.bam", sample=config["samples"]),
		bai=expand("/home/courses/instructor01/leopard_data/{sample}.mapped.sorted.bam.bai", sample=config["samples"]),
		bamlist={config["bamlist"]},
		ref={config["reference"]}
	output:
		"gatk/{dataset}.{region}.vcf"
	threads:
		config["threads"]
	params:
		#region={wildcard.region},
		prefix={config["dataset"]}
	log:
		"logs/gatk/{dataset}.{region}.snp_calling.log"
	shell:
		"bash /home/courses/instructor01/scripts/HaplotypeCaller.sh {input.bamlist} {input.ref} {wildcard.region} {params.prefix} 2> {log}"

rule vcf_filtering:
	message: """##### Running vcftools... #####"""
	input:
		vcf="gatk/{dataset}.{region}.vcf",
		ref={config["reference"]}
	output:
		"gatk/{dataset}.{region}.filtered.vcf"
	threads:
		config["threads"]
	params:
		prefix="{dataset}.{region}",
		minDP={config["minDP"]},
		maxDP={config["maxDP"]}
	log:
		"logs/gatk/{dataset}.{region}.vcf_filtering.log"
	shell:
		"vcftools --vcf {input.vcf} --recode --recode-INFO-all --out {params.prefix} "
		"--minDP {paramns.minDP} --maxDP {paramns.maxDP} --maf .05 --max-maf .95 --min-alleles 2 --max-alleles 2 "
		"--remove-indels"

rule concat_vcf:
	message: """##### Merging VCFs... #####"""
	input:
		expand("gatk/{{dataset}}.{region}.filtered.vcf", region=config["regions"]),
	output:
		"gatk/{dataset}.filtered.vcf"
	log:
		"logs/gatk/{dataset}.concat_vcf.log"
	shell:
		"bcftools concat -o {output} {input} 2> {log}"

rule vcf_stats:
	message: """##### Calculating vcf stats... #####"""
	input:
		"gatk/{dataset}.filtered.vcf"
	output:
		"gatk/stats/{dataset}.subset.vcf"
	log:
		"logs/gatk/{dataset}.vcf_stats.log"
	params:
		prefix={config["dataset"]}
	shell:
		"bash /home/courses/instructor01/scripts/vcfStats.sh {input} {params.prefix} 2> {log}"
		
#gatk VariantFiltration -V {input.vcf} \
#ls-R {input.ref} \
#-filter "MQRankSum < -12.5" --filter-name "MQRankSum-12.5" \
#-filter "ReadPosRankSum < -8.0" --filter-name "ReadPosRankSum-8" \
#-filter "QD < 2.0" --filter-name "QD2" \
#-filter "QUAL<30.0" --filter-name "QUAL30" \
#-filter "SOR>3.0" --filter-name "SOR3" \
#-filter "FS > 60.0" --filter-name "FS60" \
#-filter "MQ < 40.0" --filter-name "MQ40" \
#-O {output} 2> {log}
	
